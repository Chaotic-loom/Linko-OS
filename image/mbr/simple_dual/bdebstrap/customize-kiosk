#!/bin/sh

set -eu

mkdir -p $1/opt/linko/launcher/
rsync ../linko/launcher/LinkoLauncher.jar $1/opt/linko/launcher/

chmod 755 $1/opt/linko/launcher/

# Write out our systemd service to unblock wifi
rsync ../kiosk/unblock-wifi.service $1/etc/systemd/system/unblock-wifi.service

mkdir -p $1/etc/wpa_supplicant

APP="java -jar /opt/linko/launcher/LinkoLauncher.jar"

# Write out our systemd kiosk service
cat ../kiosk/kiosk.service.tpl | sed \
   -e "s|<KIOSK_USER>|$IGconf_device_user1|g" \
   -e "s|<KIOSK_RUNDIR>|\/home\/$IGconf_device_user1|g" \
   -e "s|<KIOSK_APP>|$APP|g" \
   > $1/etc/systemd/system/kiosk.service

# # Enable the kiosk service so it starts automatically
$BDEBSTRAP_HOOKS/enable-units "$1" kiosk

# Perms
rsync ../kiosk/perms.service $1/etc/systemd/system/perms.service

# Updater
rsync ../kiosk/kiosk-updater.service $1/etc/systemd/system/kiosk-updater.service

$BDEBSTRAP_HOOKS/enable-units "$1" perms
$BDEBSTRAP_HOOKS/enable-units "$1" kiosk-updater